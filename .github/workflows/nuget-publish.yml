name: NuGet Pack & Publish

on:
  push:
    branches: [main]
    tags:
      - '*/v*'  # e.g., HVO.Common/v1.0.0, HVO.Enterprise.Telemetry/v1.2.0
  workflow_dispatch:
    inputs:
      package:
        description: 'Package to publish (e.g., HVO.Common)'
        required: true
        type: choice
        options:
          - HVO.Common
          - HVO.Enterprise.Telemetry
          - HVO.Enterprise.Telemetry.OpenTelemetry
          - HVO.Enterprise.Telemetry.IIS
          - HVO.Enterprise.Telemetry.Wcf
          - HVO.Enterprise.Telemetry.Serilog
          - HVO.Enterprise.Telemetry.AppInsights
          - HVO.Enterprise.Telemetry.Datadog
          - HVO.Enterprise.Telemetry.Data
          - HVO.Enterprise.Telemetry.Data.EfCore
          - HVO.Enterprise.Telemetry.Data.AdoNet
          - HVO.Enterprise.Telemetry.Data.RabbitMQ
          - HVO.Enterprise.Telemetry.Data.Redis
      target:
        description: 'Publish target'
        required: true
        type: choice
        options:
          - nuget.org
          - github-packages
          - both
        default: nuget.org

jobs:
  # ── Always runs: build + test + pack validation ──
  build-and-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: |
            8.0.x
            10.0.x
      - name: Build
        run: dotnet build --configuration Release
      - name: Test
        run: dotnet test --configuration Release --no-build --verbosity normal

  pack:
    needs: build-and-test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: |
            8.0.x
            10.0.x
      - name: Pack all projects
        run: dotnet pack --configuration Release --output ./artifacts
      # Upload both .nupkg and .snupkg (symbol packages)
      - uses: actions/upload-artifact@v4
        with:
          name: nuget-packages
          path: |
            ./artifacts/*.nupkg
            ./artifacts/*.snupkg

  # ── Only on tag push or manual dispatch: publish ──
  publish-nuget:
    needs: pack
    if: >
      (startsWith(github.ref, 'refs/tags/'))
      || (github.event_name == 'workflow_dispatch'
          && (github.event.inputs.target == 'nuget.org' || github.event.inputs.target == 'both'))
    runs-on: ubuntu-latest
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: nuget-packages
          path: ./artifacts
      - name: Determine package filter
        id: filter
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            PACKAGE_NAME="${{ github.event.inputs.package }}"
          else
            # Extract package name from tag: "HVO.Common/v1.0.0" -> "HVO.Common"
            TAG="${GITHUB_REF#refs/tags/}"
            PACKAGE_NAME="${TAG%%/v*}"
          fi
          echo "package_name=${PACKAGE_NAME}" >> "$GITHUB_OUTPUT"
          echo "Publishing package: ${PACKAGE_NAME}"
      # Push .nupkg to NuGet.org (only the matching package)
      - name: Push to NuGet.org
        run: >
          dotnet nuget push "./artifacts/${{ steps.filter.outputs.package_name }}.*.nupkg"
          --api-key ${{ secrets.NUGET_API_KEY }}
          --source https://api.nuget.org/v3/index.json
          --skip-duplicate
      # Push .snupkg symbol packages (only the matching package)
      - name: Push symbols to NuGet.org
        run: >
          dotnet nuget push "./artifacts/${{ steps.filter.outputs.package_name }}.*.snupkg"
          --api-key ${{ secrets.NUGET_API_KEY }}
          --source https://api.nuget.org/v3/index.json
          --skip-duplicate

  publish-github:
    needs: pack
    if: >
      (startsWith(github.ref, 'refs/tags/'))
      || (github.event_name == 'workflow_dispatch'
          && (github.event.inputs.target == 'github-packages' || github.event.inputs.target == 'both'))
    runs-on: ubuntu-latest
    permissions:
      packages: write
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: nuget-packages
          path: ./artifacts
      - name: Determine package filter
        id: filter
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            PACKAGE_NAME="${{ github.event.inputs.package }}"
          else
            # Extract package name from tag: "HVO.Common/v1.0.0" -> "HVO.Common"
            TAG="${GITHUB_REF#refs/tags/}"
            PACKAGE_NAME="${TAG%%/v*}"
          fi
          echo "package_name=${PACKAGE_NAME}" >> "$GITHUB_OUTPUT"
          echo "Publishing package: ${PACKAGE_NAME}"
      # Push .nupkg to GitHub Packages (only the matching package)
      - name: Push to GitHub Packages
        run: >
          dotnet nuget push "./artifacts/${{ steps.filter.outputs.package_name }}.*.nupkg"
          --api-key ${{ secrets.GITHUB_TOKEN }}
          --source https://nuget.pkg.github.com/RoySalisbury/index.json
          --skip-duplicate
      # Push .snupkg symbol packages (only the matching package)
      - name: Push symbols to GitHub Packages
        run: >
          dotnet nuget push "./artifacts/${{ steps.filter.outputs.package_name }}.*.snupkg"
          --api-key ${{ secrets.GITHUB_TOKEN }}
          --source https://nuget.pkg.github.com/RoySalisbury/index.json
          --skip-duplicate
