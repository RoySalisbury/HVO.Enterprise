# Versioning Strategy

## Versioning Scheme

All HVO packages follow [SemVer 2.0](https://semver.org/): `Major.Minor.Patch[-prerelease]`

Each package is versioned **independently** — updating one package does not require version bumps in other packages.

## When to Increment

| Change Type | Version Bump | Examples |
|-------------|-------------|----------|
| **Bug fix**, internal refactor, perf improvement, doc fix | **Patch** (`1.0.0` → `1.0.1`) | Fix null reference in `TrackOperation`, improve batch export throughput, fix XML doc typo |
| **New feature**, new public API surface (backward-compatible) | **Minor** (`1.0.1` → `1.1.0`) | Add `WithOpenTelemetry()` builder method, add new overload to `AddTelemetry()`, new extension class |
| **Breaking change** to public API | **Major** (`1.1.0` → `2.0.0`) | Rename `ITelemetryService` method, remove public property, change method signature, change default behavior |

## Pre-Release Conventions

| Stage | Format | Example | Purpose |
|-------|--------|---------|---------|
| Preview | `X.Y.Z-preview.N` | `1.1.0-preview.1` | Early access, API may change |
| Release Candidate | `X.Y.Z-rc.N` | `1.1.0-rc.1` | Feature-complete, final testing |
| Stable | `X.Y.Z` | `1.1.0` | Production-ready |

## How to Release a Package (Step-by-Step)

### 1. Decide the Version Bump

Use the table above. When in doubt, use **Patch** for fixes and **Minor** for features.

### 2. Update the `.csproj` File

Edit the `Version` property in the package's `.csproj`:

```xml
<Version>1.1.0</Version>
```

Optionally update `PackageReleaseNotes`:

```xml
<PackageReleaseNotes>Added WithOpenTelemetry() builder extension. Fixed batch export delay.</PackageReleaseNotes>
```

### 3. Commit the Change

```bash
git add src/HVO.Enterprise.Telemetry/HVO.Enterprise.Telemetry.csproj
git commit -m "chore(telemetry): bump version to 1.1.0"
```

### 4. Merge to Main

Create a PR and merge. The CI pipeline will:
- ✅ Build
- ✅ Test
- ✅ Pack (validation only)
- ❌ **Not publish** — merges never trigger publishing

### 5. Create a Git Tag

```bash
git tag "HVO.Enterprise.Telemetry/v1.1.0"
git push origin "HVO.Enterprise.Telemetry/v1.1.0"
```

### 6. CI Publishes Automatically

The tag push triggers the CI pipeline which publishes the `.nupkg` and `.snupkg` to nuget.org and/or GitHub Packages.

## Publishing Flow

```
Merge PR to main
  └── CI: build ✓ → test ✓ → pack ✓ (validation only, NO publish)

Push tag: HVO.Common/v1.0.1
  └── CI: build ✓ → test ✓ → pack ✓ → publish .nupkg + .snupkg ✓
```

## Tag Format

```
<PackageId>/v<Version>
```

Examples:
- `HVO.Common/v1.0.1`
- `HVO.Enterprise.Telemetry/v1.1.0`
- `HVO.Enterprise.Telemetry.Data.Redis/v1.0.0-preview.1`

## What NOT to Do

- **Don't bump versions on merge** — merging to main only validates the pack. Publishing only happens when you push a tag.
- **Don't bump other packages** when one changes — each package is versioned independently.
- **Don't reuse a version** — once `1.0.1` is published, it's immutable on NuGet. If you need a fix, go to `1.0.2`.
- **Don't skip versions** — go `1.0.0` → `1.0.1` → `1.0.2`, not `1.0.0` → `1.0.5`.

## Cross-Package Dependencies

In the source repo, packages reference each other via `ProjectReference` (always builds from source). When packed into `.nupkg`, the SDK automatically converts `ProjectReference` into a NuGet dependency with a version range like `[1.0.0, )` based on the referenced project's `Version` property.

If you bump `HVO.Enterprise.Telemetry` from `1.0.0` to `1.1.0`, all extension packages that reference it will automatically require `>= 1.1.0` when next packed. You do **not** need to bump the extension package versions unless they have their own changes.

## Assembly Versioning

| Property | Value | Purpose |
|----------|-------|---------|
| `Version` | `1.1.0` | NuGet package version (SemVer) |
| `AssemblyVersion` | `1.0.0.0` | CLR binding version (keep stable within major) |
| `FileVersion` | `1.1.0.0` | Windows file properties |
| `InformationalVersion` | `1.1.0+<git-sha>` | Full version with source commit (auto-generated by Source Link) |

**Note:** `AssemblyVersion` should only change on **major** version bumps to avoid binding redirect issues for .NET Framework consumers. The SDK defaults `AssemblyVersion` to `Version` — override with `<AssemblyVersion>1.0.0.0</AssemblyVersion>` if needed.

## Manual Publishing

For ad-hoc publishing without creating a tag, use the GitHub Actions **manual workflow dispatch**:

1. Go to **Actions** → **NuGet Pack & Publish**
2. Click **Run workflow**
3. Select the package and publish target
4. Click **Run workflow**

This is useful for re-publishing after a failed CI run or for publishing pre-release versions.
