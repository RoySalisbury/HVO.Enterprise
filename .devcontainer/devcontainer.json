{
  "name": "HVO.Enterprise Dev Container",
  "image": "mcr.microsoft.com/devcontainers/dotnet:10.0",
  "features": {
    "ghcr.io/devcontainers/features/git:1": {
      "ppa": true,
      "version": "latest"
    },
    "ghcr.io/devcontainers/features/github-cli:1": {
      "installDirectlyFromGitHubRelease": true,
      "version": "latest"
    },
    "ghcr.io/devcontainers/features/common-utils:2": {
      "installZsh": true,
      "installOhMyZsh": true,
      "configureZshAsDefaultShell": true,
      "username": "vscode",
      "userUid": "automatic",
      "userGid": "automatic",
      "upgradePackages": true
    },
    "ghcr.io/devcontainers/features/dotnet:2": {
      "version": "10.0",
      "installUsingApt": true,
      "dotnetRuntimeVersions": "10.0"
    },
    "ghcr.io/devcontainers/features/docker-in-docker:2": {
      "version": "latest",
      "moby": true,
      "dockerDashComposeVersion": "v2",
      "installDockerComposeSwitch": false
    }
  },
  "customizations": {
    "vscode": {
      "extensions": [
        "ms-dotnettools.csdevkit",
        "ms-dotnettools.csharp",
        "ms-dotnettools.vscode-dotnet-runtime",
        "GitHub.copilot",
        "GitHub.copilot-chat",
        "github.vscode-github-actions",
        "ms-vscode.vscode-js-profile-flame",
        "openai.chatgpt"
      ],
      "settings": {
        "omnisharp.enableRoslynAnalyzers": true,
        "omnisharp.enableEditorConfigSupport": true,
        "omnisharp.enableImportCompletion": true,
        "csharp.semanticHighlighting.enabled": true,
        "editor.formatOnSave": true,
        "editor.formatOnType": true,
        "editor.codeActionsOnSave": {
          "source.fixAll": "explicit",
          "source.organizeImports": "explicit"
        }
      }
    }
  },
  // Environment variables for dev container (non-sensitive only)
  // Secrets should be provided via User Secrets or .devcontainer/devcontainer.local.env (gitignored)
  // See docs/security/secrets-guide.md for comprehensive secret management
  "containerEnv": {
    "ASPNETCORE_ENVIRONMENT": "Development",
    "DOTNET_ENVIRONMENT": "Development",
    "DOCKER_HOST_ADDRESS": "0.0.0.0",
    "POSTGRES_DOCKER_CONTEXT": "proxmox-home",
    // Identity Hardening - Logging Configuration (non-sensitive)
    "LOGGING_LOGLEVEL_DEFAULT": "Information",
    "LOGGING_LOGLEVEL_MICROSOFT_ASPNETCORE": "Warning",
    "APPLICATIONINSIGHTS_CONNECTION_STRING": "InstrumentationKey=461820e1-768d-49c2-9ffa-dcadc6f8076a;IngestionEndpoint=https://westus3-1.in.applicationinsights.azure.com/;LiveEndpoint=https://westus3.livediagnostics.monitor.azure.com/;ApplicationId=ffe9f937-60da-4b07-8645-88b24d8f5e4f"
  },
  "remoteEnv": {
    // Point to Docker Desktop's magic SSH bridge on macOS
    "SSH_AUTH_SOCK": "/run/host-services/ssh-auth.sock"
  },
  // Port mappings with allInterfaces for Docker-from-Docker accessibility
  // 5000-5001: Main HVO.SkyMonitor app (HTTP/HTTPS)
  // 5010-5011: Camera Agent (HTTP/HTTPS)
  // 5432: PostgreSQL, 6379: Redis
  // 9000-9001: MinIO (API/Console)
  // 7096: Logic Host HTTPS (dotnet run)
  // 5174: SkyMonitor container mode (HTTP)
  // 5130: Camera agent container mode
  "forwardPorts": [
    5000,
    5001
  ],
  "portsAttributes": {
    "5000": {
      "onAutoForward": "notify",
      "elevateIfNeeded": true
    },
    "5001": {
      "onAutoForward": "notify",
      "elevateIfNeeded": true
    }
  },
  // Ensure host-side SSH agent directory exists to avoid bind mount errors
  "initializeCommand": "",
  // Mount user secrets from host into container
  // Allows dev container to access locally stored secrets
  "mounts": [
    // SSH agent socket from host -> container
    {
      "source": "/run/host-services/ssh-auth.sock",
      "target": "/run/host-services/ssh-auth.sock",
      "type": "bind"
    },
    {
      "type": "volume",
      "source": "x509stores",
      "target": "/home/vscode/.dotnet/corefx/cryptography/x509stores"
    },
    {
      "type": "bind",
      "source": "${localEnv:HOME}${localEnv:USERPROFILE}/.microsoft/usersecrets",
      "target": "/home/vscode/.microsoft/usersecrets"
    }
  ],
  "postStartCommand": "sudo chgrp vscode /run/host-services/ssh-auth.sock && sudo chmod 660 /run/host-services/ssh-auth.sock",
  "postCreateCommand": "bash .devcontainer/post-create.sh",
  "remoteUser": "vscode"
}